<div class="container">
  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button class="btn-back" (click)="backToJobOffers()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Retour aux offres
        </button>
        <h1 class="page-title">Candidatures</h1>
        <p class="page-subtitle">{{ filteredApplications.length }} candidature(s) • {{ getAcceptedCount() }} acceptée(s)</p>
      </div>
      <div class="header-right">
        <button class="btn-secondary" (click)="exportData()">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Exporter
        </button>
      </div>
    </div>
  </header>

  <!-- Toolbar Section -->
  <section class="toolbar">
    <div class="toolbar-left">
      <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          class="search-input"
          placeholder="Rechercher un candidat..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
        />
        <button *ngIf="searchQuery" class="clear-search" (click)="clearSearch()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="filter-chips">
        <button
          class="filter-chip"
          [class.active]="selectedStatus === status.value"
          *ngFor="let status of statusOptions.slice(1, 6)"
          (click)="toggleStatusFilter(status.value)"
        >
          <span class="chip-dot" [class]="status.value"></span>
          {{ status.label }}
        </button>
      </div>
    </div>

    <div class="toolbar-right">
      <select class="filter-select compact" [(ngModel)]="selectedDegree" (change)="onDegreeFilterChange()">
        <option *ngFor="let option of degreeOptions" [value]="option.value">{{ option.label }}</option>
      </select>

      <div class="score-filter">
        <label for="minScore" class="score-label">Score min:</label>
        <input
          id="minScore"
          type="number"
          class="score-input"
          min="0"
          max="100"
          placeholder="0"
          [(ngModel)]="minScore"
          (input)="onScoreFilterChange()"
        />
      </div>

      <button class="btn-icon-only" (click)="toggleView()" title="Changer de vue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
        </svg>
      </button>

      <button *ngIf="hasActiveFilters()" class="btn-text" (click)="resetFilters()">
        Réinitialiser
      </button>
    </div>
  </section>

  <!-- Bulk Actions Bar -->
  <div *ngIf="selectedApplications.length > 0" class="bulk-actions-bar">
    <div class="bulk-info">
      <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll()" class="checkbox-main" />
      <span class="bulk-count">{{ selectedApplications.length }} sélectionnée(s)</span>
    </div>

    <div class="bulk-actions">
      <!-- Bouton Présélectionner -->
      <button
        class="btn-bulk btn-shortlist"
        (click)="bulkShortlist()"
        [disabled]="isShortlisting"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span *ngIf="!isShortlisting">Présélectionner</span>
        <span *ngIf="isShortlisting" class="loading-text">
        <span class="spinner-small"></span>
        Présélection...
      </span>
      </button>

      <!-- Bouton Changer le statut avec Dropdown -->
      <div class="status-dropdown-container">
        <button class="btn-bulk" (click)="toggleStatusDropdown()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Changer le statut
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron-icon" [class.rotated]="showStatusDropdown">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <!-- Dropdown Menu -->
        <div *ngIf="showStatusDropdown" class="status-dropdown-menu">
          <div class="dropdown-header">
            <span>Sélectionnez un nouveau statut</span>
          </div>
          <div class="status-options">
            <button
              *ngFor="let option of statusChangeOptions"
              class="status-option"
              [class.selected]="selectedNewStatus === option.value"
              (click)="selectStatus(option.value)"
            >
              <span class="status-icon">{{ option.icon }}</span>
              <span class="status-label">{{ option.label }}</span>
              <span *ngIf="selectedNewStatus === option.value" class="check-icon">✓</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Bouton Supprimer -->
      <button class="btn-bulk danger" (click)="bulkDelete()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Supprimer
      </button>
    </div>
  </div>

  <!-- Section Commentaire (apparaît quand un statut est sélectionné) -->
  <div *ngIf="showStatusDropdown && selectedNewStatus" class="status-comment-section">
    <div class="comment-header">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="comment-icon">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span class="comment-title">Ajouter un commentaire (optionnel)</span>
    </div>

    <textarea
      class="comment-textarea"
      [(ngModel)]="statusComment"
      placeholder="Expliquez la raison du changement de statut..."
      rows="3"
    ></textarea>

    <div class="comment-actions">
      <button class="btn-secondary-small" (click)="cancelStatusChange()">
        Annuler
      </button>
      <button
        class="btn-primary-small"
        (click)="bulkChangeStatus()"
        [disabled]="isUpdatingStatus"
      >
      <span *ngIf="!isUpdatingStatus">
        Confirmer le changement
      </span>
        <span *ngIf="isUpdatingStatus" class="loading-text">
        <span class="spinner-small"></span>
        Mise à jour...
      </span>
      </button>
    </div>

    <div class="status-change-preview">
      <span class="preview-label">Nouveau statut :</span>
      <span class="preview-status">{{ getStatusLabel(selectedNewStatus) }}</span>
      <span class="preview-count">pour {{ selectedApplications.length }} candidature(s)</span>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement des candidatures...</p>
  </div>

  <!-- Data Table -->
  <div class="table-container">
    <table class="data-table">
      <thead>
      <tr>
        <th class="col-checkbox">
          <input
            type="checkbox"
            [checked]="isAllSelected()"
            [indeterminate]="isSomeSelected()"
            (change)="toggleSelectAll()"
            class="checkbox-main"
          />
        </th>
        <th class="col-candidate sortable" (click)="sortBy('candidateName')">
          <div class="th-content">
            <span>Candidat</span>
            <span class="sort-icon" *ngIf="sortColumn === 'candidateName'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-email sortable" (click)="sortBy('candidateEmail')">
          <div class="th-content">
            <span>Email</span>
            <span class="sort-icon" *ngIf="sortColumn === 'candidateEmail'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-degree sortable" (click)="sortBy('highestDegree')">
          <div class="th-content">
            <span>Diplôme</span>
            <span class="sort-icon" *ngIf="sortColumn === 'highestDegree'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-field sortable" (click)="sortBy('majorField')">
          <div class="th-content">
            <span>Domaine</span>
            <span class="sort-icon" *ngIf="sortColumn === 'majorField'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-score sortable" (click)="sortBy('scoreIA')">
          <div class="th-content">
            <span>Score IA</span>
            <span class="sort-icon" *ngIf="sortColumn === 'scoreIA'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-status sortable" (click)="sortBy('status')">
          <div class="th-content">
            <span>Statut</span>
            <span class="sort-icon" *ngIf="sortColumn === 'status'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-date sortable" (click)="sortBy('submitDate')">
          <div class="th-content">
            <span>Date de soumission</span>
            <span class="sort-icon" *ngIf="sortColumn === 'submitDate'">
              {{ sortDirection === 'asc' ? '↑' : '↓' }}
            </span>
          </div>
        </th>
        <th class="col-actions">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr
        *ngFor="let app of filteredApplications"
        class="table-row"
        [class.selected]="isSelected(app.id)"
      >
        <td class="col-checkbox">
          <input
            type="checkbox"
            [checked]="isSelected(app.id)"
            (change)="toggleSelect(app.id)"
            class="checkbox-row"
          />
        </td>

        <td class="col-candidate">
          <div class="candidate-cell">
            <div class="candidate-avatar">
              {{ (app.candidateName || '?').charAt(0).toUpperCase() }}
            </div>
            <span class="candidate-name" (click)="viewApplicationDetails(app.id)">{{ app.candidateName }}</span>
          </div>
        </td>

        <td class="col-email">
          <a [href]="'mailto:' + app.candidateEmail" class="email-link">{{ app.candidateEmail }}</a>
        </td>

        <td class="col-degree">
          <div class="degree-badge">
            <svg class="degree-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
              <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
            </svg>
            {{ app.highestDegree || '-' }}
          </div>
        </td>

        <td class="col-field">
          <span class="field-text">{{ app.majorField || '-' }}</span>
        </td>

        <td class="col-score">
          <div class="score-cell" [ngClass]="getScoreColor(app.scoreIA)">
            <div class="score-bar">
              <div class="score-fill" [style.width.%]="app.scoreIA || 0"></div>
            </div>
            <span class="score-value">{{ app.scoreIA || 0 }}%</span>
          </div>
        </td>

        <td class="col-status">
          <span class="status-badge" [ngClass]="getStatusClass(app.status)">
            <span class="status-dot"></span>
            {{ getStatusLabel(app.status) }}
          </span>
        </td>

        <td class="col-date">
          <div class="date-cell">
            <span class="date-value">{{ formatDate(app.submitDate) }}</span>
            <span class="date-relative">{{ getRelativeDate(app.submitDate) }}</span>
          </div>
        </td>

        <td class="col-actions">
          <div class="actions-cell">
            <button class="btn-action" (click)="viewApplicationDetails(app.id)" title="Voir les détails">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
            <button class="btn-action" (click)="downloadCV(app.cvUrl)" title="Télécharger CV" [disabled]="!app.cvUrl">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="btn-action danger" (click)="deleteApplication(app)" title="Supprimer">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && !errorMessage && filteredApplications.length > 0" class="pagination">
    <div class="pagination-info">
      Affichage de <strong>{{ filteredApplications.length }}</strong> sur <strong>{{ applications.length }}</strong> candidature(s)
    </div>
  </div>
</div>
